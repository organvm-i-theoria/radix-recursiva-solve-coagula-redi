name: AI Assisted Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  ai-review:
    name: Generate AI review notes
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sumy==0.11.0 textstat==0.7.3

      - name: Check for required environment variables
        env:
          API_KEY: "dummy-key"
          DATABASE_URL: "dummy-url"
        run: python scripts/check_env_vars.py

      - name: Generate AI review
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.sha }}
        run: |
          python scripts/ai_reviewer.py --base "$BASE_SHA" --head "$HEAD_SHA" --output ai_review_report.md

      - name: Upload review summary
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-report
          path: ai_review_report.md

      - name: Share feedback on the pull request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('ai_review_report.md', 'utf8');
            const header = 'ðŸ¤– **AI-assisted review summary**\n\n';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: header + body,
            });

  configuration-hint:
    name: Draft pull request note
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.draft }}
    steps:
      - name: Skip message
        run: |
          cat <<'MSG' >> "$GITHUB_STEP_SUMMARY"
          ## AI review skipped for draft pull request
          Mark the pull request as "Ready for review" to trigger the AI-assisted reviewer.
          MSG
