name: Jules Branch Cleanup

on:
    schedule:
        - cron: "0 2 * * 0" # Weekly Sunday 02:00 UTC
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Dry run (do not delete branches)"
                required: false
                default: "true"
            max_age_days:
                description: "Delete branches older than this many days"
                required: false
                default: "30"
            prefixes:
                description: "Comma-separated branch prefixes (default: bolt-,sentinel-,palette-)"
                required: false
                default: "bolt-,sentinel-,palette-"

jobs:
    cleanup:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Fetch remote refs
              run: |
                  git fetch --prune --tags origin

            - name: Snapshot branch tips (pre-cleanup)
              env:
                  DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
                  MAX_AGE_DAYS: ${{ github.event.inputs.max_age_days || '30' }}
                  PREFIXES: ${{ github.event.inputs.prefixes || 'bolt-,sentinel-,palette-' }}
              run: |
                  set -euo pipefail

                  DEFAULT_BRANCH='${{ github.event.repository.default_branch }}'
                  TS="$(date -u +%Y%m%d-%H%M%S)"
                  OUT="branch_tips_pre_cleanup_${TS}.txt"

                  {
                    echo "# Jules cleanup branch-tip snapshot"
                    echo "# repo: $GITHUB_REPOSITORY"
                    echo "# timestamp_utc: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
                    echo "# dry_run: $DRY_RUN"
                    echo "# max_age_days: $MAX_AGE_DAYS"
                    echo "# prefixes: $PREFIXES"
                    echo "# format: <sha>\t<ref>"
                    echo ""
                    echo "# Default branch tip"
                    git ls-remote --heads origin "refs/heads/${DEFAULT_BRANCH}" || true
                    echo ""
                    echo "# Prefixed branch tips"
                  } > "$OUT"

                  IFS=',' read -r -a PREFIX_ARR <<< "$PREFIXES"
                  for p in "${PREFIX_ARR[@]}"; do
                    p_trimmed="$(echo "$p" | xargs)"
                    if [ -n "$p_trimmed" ]; then
                      git ls-remote --heads origin "refs/heads/${p_trimmed}*" >> "$OUT" || true
                    fi
                  done

                  echo "Wrote snapshot: $OUT" >> "$GITHUB_STEP_SUMMARY"

            - name: Upload branch-tip snapshot
              uses: actions/upload-artifact@v4
              with:
                  name: jules-cleanup-branch-tip-snapshot
                  path: branch_tips_pre_cleanup_*.txt

            - name: Backup current default branch
              run: |
                  DEFAULT_BRANCH='${{ github.event.repository.default_branch }}'
                  TAG="jules-cleanup-backup-$(date +%Y%m%d-%H%M%S)"
                  git tag "$TAG" "origin/${DEFAULT_BRANCH}"
                  git push origin "$TAG"
                  echo "Created backup tag: $TAG" >> "$GITHUB_STEP_SUMMARY"

            - name: Cleanup stale branches
              id: cleanup
              env:
                  DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
                  MAX_AGE_DAYS: ${{ github.event.inputs.max_age_days || '30' }}
                  PREFIXES: ${{ github.event.inputs.prefixes || 'bolt-,sentinel-,palette-' }}
              run: |
                  IFS=',' read -r -a PREFIX_ARR <<< "$PREFIXES"
                  ARGS=("--repo-path" "." "--remote" "origin" "--max-age-days" "$MAX_AGE_DAYS")

                  for p in "${PREFIX_ARR[@]}"; do
                    p_trimmed="$(echo "$p" | xargs)"
                    if [ -n "$p_trimmed" ]; then
                      ARGS+=("--prefix" "$p_trimmed")
                    fi
                  done

                  if [ "$DRY_RUN" = "true" ]; then
                    ARGS+=("--dry-run")
                  fi

                  set +e
                  python3 scripts/jules/cleanup_stale_branches.py "${ARGS[@]}" | tee cleanup.log
                  EXIT_CODE=${PIPESTATUS[0]}
                  set -e

                  echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

            - name: Report
              run: |
                  echo "## Jules branch cleanup" >> "$GITHUB_STEP_SUMMARY"
                  echo "- dry_run: ${{ github.event.inputs.dry_run || 'true' }}" >> "$GITHUB_STEP_SUMMARY"
                  echo "- max_age_days: ${{ github.event.inputs.max_age_days || '30' }}" >> "$GITHUB_STEP_SUMMARY"
                  echo "- prefixes: ${{ github.event.inputs.prefixes || 'bolt-,sentinel-,palette-' }}" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "### Output" >> "$GITHUB_STEP_SUMMARY"
                  echo "\n\`\`\`\n$(tail -200 cleanup.log)\n\`\`\`\n" >> "$GITHUB_STEP_SUMMARY"

            - name: Upload cleanup log
              uses: actions/upload-artifact@v4
              with:
                  name: jules-cleanup-log
                  path: cleanup.log
